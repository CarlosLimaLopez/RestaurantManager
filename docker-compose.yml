version: '3.8'

services:
  # API Backend
  restaurantmanager-api:
    image: ghcr.io/carloslimalopez/restaurantmanager-api:latest
    container_name: restaurantmanager-api
    build:
      context: .
      dockerfile: RestaurantManager.API/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__Database=User Id=postgres.kfzzuqjmuscxyzbocwfz;Password=YPVI4dBxq0WRYQW6vwSE;Server=aws-1-eu-west-1.pooler.supabase.com;Port=5432;Database=postgres
    networks:
      - restaurantmanager-network
    restart: unless-stopped

  # Blazor Public Interface
  restaurantmanager-public:
    image: ghcr.io/carloslimalopez/restaurantmanager-public:latest
    container_name: restaurantmanager-public
    build:
      context: .
      dockerfile: RestaurantManager.Interface.Public/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - RestaurantManagerApiAddress=http://restaurantmanager-api:8080/api/
    depends_on:
      - restaurantmanager-api
    networks:
      - restaurantmanager-network
    restart: unless-stopped

  # Blazor Admin Interface
  restaurantmanager-interface:
    image: ghcr.io/carloslimalopez/restaurantmanager-interface:latest
    container_name: restaurantmanager-interface
    build:
      context: .
      dockerfile: RestaurantManager.Interface/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
    depends_on:
      - restaurantmanager-api
    networks:
      - restaurantmanager-network
    restart: unless-stopped

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: restaurantmanager-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - restaurantmanager-api
      - restaurantmanager-public
      - restaurantmanager-interface
    networks:
      - restaurantmanager-network
    restart: unless-stopped

networks:
  restaurantmanager-network:
    driver: bridge
